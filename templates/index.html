<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>닫기가 가능한 커스텀 오버레이</title>
    <style>
    .wrap {position: absolute;left: 0;bottom: 40px;width: 288px;height: 132px;margin-left: -144px;text-align: left;overflow: hidden;font-size: 13px;font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;line-height: 1.5;}
    .wrap * {padding: 0;margin: 0;}
    .wrap .info {width: 286px;height: 120px;border-radius: 5px;border-bottom: 2px solid #ccc;border-right: 1px solid #ccc;overflow: hidden;background: #fff;}
    .wrap .info:nth-child(1) {border: 0;box-shadow: 0px 1px 2px #888;}
    .info .title {padding: 5px 0 0 10px;height: 25px;background: #eee;border-bottom: 1px solid #ddd;font-size: 13x;font-weight: bold;}
    .info .body {position: relative;overflow: hidden;}
    .info .desc {position: relative;margin: 5px 0 0 13px;height: 75px;}
    .desc .address {overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}
    .desc .phone {font-size: 13px;color: #888;margin-top: -2px;}
    .info:after {content: ''; position: absolute;background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')}
    .info .link {color: #5085BB;}
</style>
</head>
<body>
<div id="map" style="width:100%;height:100vh;"></div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7e9a9b13be9fa68e0f74c3f57b0000da"></script>
<script src="https://code.jquery.com/jquery-latest.min.js"></script> 

<script>
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
        mapOption = { 
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
            level: 2 // 지도의 확대 레벨 
        }; 

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude; // 위도
            var lon = position.coords.longitude; // 경도
            var locPosition = new kakao.maps.LatLng(lat, lon);
            map.setCenter(locPosition);
            fixPosition(locPosition);
        })}

    else {
        var lat = 33.450701;
        var lon = 126.570667;
        var locPosition = new kakao.maps.LatLng(lat, lon);
        map.setCenter(locPosition);
        fixPosition(locPosition);
    };

    function fixPosition(locPosition) {
        var marker = new kakao.maps.Marker({  
            map: map, 
            position: locPosition,
            draggable: true,
            clickable: true
        }); 

        // 인포윈도우를 생성합니다
        var infowindow = new kakao.maps.InfoWindow({
            content : "마커 좌클릭 시 위치 고정",
            removable : false
        });

        // 인포윈도우를 마커위에 표시합니다 
        infowindow.open(map, marker);

        kakao.maps.event.addListener(marker, 'dragstart', function() {
        // 마커의 드래그가 시작될 때 인포윈도우도 따라가도록 합니다
            infowindow.close();});

        kakao.maps.event.addListener(marker, 'dragend', function() {
        // 마커의 드래그가 종료될 때 infowindow를 닫는다.
            infowindow.open(map, marker);
            marker.clickable = false;
        });

        var mapClickHandler = function(mouseEvent) {        
            var latlng = mouseEvent.latLng; 
            marker.setPosition(latlng);
            infowindow.setPosition(latlng);
        };

        kakao.maps.event.addListener(map, 'click', mapClickHandler);

        kakao.maps.event.addListener(marker, 'click', function() {
            latlng = marker.getPosition();
            map.setCenter(latlng);
            infowindow.close();
            kakao.maps.event.removeListener(map, 'click', mapClickHandler);
            marker.setDraggable(false);
            map.level = 3;
            postCafe(latlng, showCafes);
        });
    };

    function showCafes(result){
        if (result == []){
            pass
        }
        else {
            var cafemarker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(lat, lon)
            })

            var markers = [];

            for (i in result.Cafe) {
                e = result.Cafe[i];
                if (e.americano==0){
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: new kakao.maps.LatLng(e.y, e.x)
                    });
                }
                else {
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: new kakao.maps.LatLng(e.y, e.x)
                    });

                    var content = '<div class="wrap">' +
                                '    <div class="info">' +
                                '        <div class="title">' +
                                            e.place_name +
                                '        </div>' +
                                '        <div class="body">' +
                                '            <div class="desc">' + e.americano + 
                                '               <div class="address">' + e.road_address_name + '</div>' +
                                '                <div class="phone">' + e.phone + '</div>' +
                                '                <div><a href=http://place.map.kakao.com/' + e.id + ' target="_blank" class="link">홈페이지</a></div>' +
                                '            </div>' +
                                '        </div>' +
                                '    </div>' +
                                '</div>';
                                    

                    // 마커 위에 커스텀오버레이를 표시합니다
                    // 마커를 중심으로 커스텀 오버레이를 표시하기위해 CSS를 이용해 위치를 설정했습니다
                    var overlay = new kakao.maps.CustomOverlay({
                        content: content,
                        map: map,
                        position: marker.getPosition()
                    });

                    // 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
                    kakao.maps.event.addListener(marker, 'click', function() {
                        if(overlay.getMap()==null){
                            overlay.setMap(map);
                        }
                        else{
                            overlay.setMap(null);
                        }
                    });
                    markers.push(marker);
                }
            };
        };
    };

    function postCafe(latlng, callback) {
        lat = latlng.getLat();
        lon = latlng.getLng();
        $.ajax({
            type : 'POST',
            url : '/',
            dataType : 'json',
            contentType: "application/json",
            data : {
                "lat" : lat,
                "lon" : lon
            },
            async : true,
            success : function(response) {
                var status = response.state;
                if(status == "error"){
                    alert("POST 실패");
                    callback(null);
                }
                else {
                    callback(JSON.parse(response));
                }
            },
            error : function(request, status, error){
                console.log(request + "/" + status + "/" + error);
            }
        });
    }  
</script>
</body>
</html>